# 三个问题修复说明

## 修复日期
2024年（当前版本）

## 修复的问题

### 1. OSS上传不包含父文件夹结构

**问题描述：**
- 用户选择"西沟乡麻地沟村（资料扫描）"作为根目录
- 处理子目录"何皂皂"时，文件上传到OSS的路径为：`test/何皂皂/image.jpg`
- 但用户期望的是：`test/西沟乡麻地沟村（资料扫描）/何皂皂/image.jpg`

**问题原因：**
- `upload_directory_to_oss()` 函数只使用了子目录名，没有包含根目录名

**修复方案：**
1. 修改 `process_directory()` 函数，添加 `root_dir` 参数
2. 修改 `upload_directory_to_oss()` 函数，构建完整路径：`root_name/dir_name`
3. 更新所有调用 `process_directory()` 的地方，传递 `root_dir` 参数

**修复代码位置：**
- `main.py` 第 520 行：`process_directory()` 函数签名
- `main.py` 第 482 行：`upload_directory_to_oss()` 函数
- `main.py` 第 717 行：`process_all_directories()` 中的调用
- `main.py` 第 679 行：`upload_all_directories()` 中的调用

### 2. 二维码URL指向错误位置

**问题描述：**
- 生成的二维码扫描后，访问的是空白的上级目录（如 `test/`）
- 应该指向实际的图片目录（如 `test/西沟乡麻地沟村（资料扫描）/何皂皂/`）

**问题原因：**
- 默认URL构建时只使用了子目录名，没有包含完整路径
- 与问题1相关，是同一个根本原因

**修复方案：**
- 修改默认URL构建逻辑，包含根目录名称
- 确保上传成功后返回的URL前缀是正确的

**修复代码位置：**
- `main.py` 第 550-564 行：默认OSS URL构建逻辑

### 3. 缺少PDF页面方向选择

**问题描述：**
- 用户无法选择PDF是横向还是纵向
- 只能使用默认的纵向排版

**修复方案：**
1. 在GUI中添加页面方向选择（横向/纵向）
2. 导入 `landscape` 函数从 reportlab
3. 修改 `get_page_size()` 函数，根据选择应用横向或纵向
4. 对于标准尺寸（A3/A4/A5），使用 `landscape()` 函数
5. 对于自定义尺寸，交换宽度和高度

**修复代码位置：**
- `main.py` 第 17 行：导入 `landscape`
- `main.py` 第 212-217 行：添加页面方向选择控件
- `main.py` 第 341-363 行：修改 `get_page_size()` 函数

## 修复后的效果

### OSS路径结构
```
test/
└── 西沟乡麻地沟村（资料扫描）/
    ├── 何皂皂/
    │   ├── image1.jpg
    │   ├── image2.jpg
    │   └── ...
    ├── 刘彩统/
    │   ├── image1.jpg
    │   └── ...
    └── ...
```

### 二维码URL
```
https://your-bucket.oss-region.aliyuncs.com/test/西沟乡麻地沟村（资料扫描）/何皂皂
```

### PDF方向选择
- 纵向（默认）：A4 = 210mm × 297mm
- 横向：A4 = 297mm × 210mm

## 测试建议

1. **测试OSS上传路径：**
   ```
   1. 选择根目录：西沟乡麻地沟村（资料扫描）
   2. 配置OSS，base_path 设置为 "test"
   3. 开始处理（启用自动上传）
   4. 检查OSS中的文件路径是否为：test/西沟乡麻地沟村（资料扫描）/何皂皂/xxx.jpg
   ```

2. **测试二维码URL：**
   ```
   1. 使用微信扫描生成的二维码
   2. 检查打开的URL是否包含完整路径
   3. 确认URL可以访问到图片列表（需要OSS bucket设置为公共读）
   ```

3. **测试PDF方向：**
   ```
   1. 选择A4尺寸
   2. 选择"横向"
   3. 生成PDF
   4. 打开PDF检查页面是否为横向（宽度>高度）
   ```

## 版本信息

- 修复版本：v1.1.0
- 修复前版本：v1.0.1
- Python版本要求：3.9+
- 主要依赖：qrcode, reportlab, oss2

## 注意事项

1. OSS路径中的中文字符可能在某些情况下需要URL编码
2. 如果OSS bucket不是公共读，需要使用签名URL
3. 横向PDF在某些阅读器中可能显示效果不同
4. 建议在更新后测试完整流程：选择目录 → 上传 → 生成二维码 → 生成PDF → 扫描验证
